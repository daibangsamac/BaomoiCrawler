name: Java CI/CD - Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 1.8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Display Java version
      run: |
        java -version
        javac -version

    - name: Prepare build directories
      run: |
        if exist bin rmdir /s /q bin
        mkdir bin
      shell: cmd

    - name: Compile Java sources
      run: |
        set FILES= \
        for /R src %%f in (*.java) do (
            set FILES=!FILES! %%f
        )
        javac -cp "libs/*" -d bin @FILES
      shell: cmd

    - name: Run Tests
      run: |
        setlocal enabledelayedexpansion
        set CLASSES=
        for /R bin %%f in (*Test.class) do (
            set F=%%f
            set F=!F:bin\=!
            set F=!F:\=.! 
            set F=!F:.class=!
            set CLASSES=!CLASSES! !F!
        )
        for %%T in (!CLASSES!) do (
            java -cp "bin;libs/*" org.junit.runner.JUnitCore %%T
        )
      shell: cmd