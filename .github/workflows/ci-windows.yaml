name: Java CI/CD - Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK 1.8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Display Java version
      run: |
        java -version
        javac -version

    - name: Prepare build directories
      run: |
        if exist bin rmdir /s /q bin
        mkdir bin
      shell: cmd

    - name: Compile Java sources
      run: |
        setlocal enabledelayedexpansion

        set FILES=
        for /R src %%f in (*.java) do (
          set FILES=!FILES! "%%f"
        )

        javac -cp "libs/*" -d bin !FILES!
      shell: cmd

    - name: Run Tests
      run: |
        setlocal enabledelayedexpansion
        REM Root folder tuyệt đối phải trùng với folder bin nằm trong đó
        set ROOT=D:\a\BaomoiCrawler\BaomoiCrawler\
        
        set CLASSES=

        for /R bin %%f in (*Test.class) do (
        set F=%%f

        REM Bỏ root prefix
        set F=!F:%ROOT%=!
        
        REM Bỏ prefix bin\
        set F=!F:bin\=!

        REM Đổi \ thành .
        set F=!F:\=.!

        REM Bỏ phần .class
        set F=!F:.class=!

        REM Bỏ dấu chấm đầu nếu có
        if "!F:~0,1!"=="." set F=!F:~1!

        set CLASSES=!CLASSES! !F!
        )

        echo Running test classes: !CLASSES!

        for %%T in (!CLASSES!) do (
            echo Running %%T
            java -cp "bin;libs/*" org.junit.runner.JUnitCore %%T
        )
      shell: cmd